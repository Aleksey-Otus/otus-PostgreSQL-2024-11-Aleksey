# Выполнение
<br>Подключились к ВМ с Postgresql, созданной в VirtualBox:
<br>ssh -p 3022 yuriy@127.0.0.1

<br>Инициализировали pgbench:
<br>pgbench -U postgres -h 0.0.0.0 -i testWal

<img width="815" height="521" alt="1" src="https://github.com/user-attachments/assets/0124a5ab-a8cd-4de2-869e-6df1661886d0" />


<br><b>Настройте выполнение контрольной точки раз в 30 секунд.</b>

<br>show checkpoint_timeout; --5min
<br>ALTER SYSTEM SET checkpoint_timeout = '30s';
<br>SELECT pg_reload_conf();
<br>show checkpoint_timeout; --30s

<img width="1418" height="655" alt="2" src="https://github.com/user-attachments/assets/306613de-7913-46b1-8e61-4da129e48322" />


<br><b>10 минут c помощью утилиты pgbench подавайте нагрузку.</b>
pgbench -U postgres -T 600 testWal

<br><b>Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку.</b>
<br>lsn до запуска pgbench
<br>SELECT pg_current_wal_insert_lsn(); ----1/BD202710

<br>lsn ПОСЛЕ запуска pgbench:
<br>SELECT pg_current_wal_insert_lsn(); --1/D09B70E0

<br>select checkpoints_timed from pg_stat_bgwriter; --187  --208

<br>Контрольных точек прошло:
<br>208 - 187 = 21

<br>CREATE EXTENSION pg_buffercache;
<br>SELECT count(*) FROM pg_buffercache WHERE isdirty; --1 --1791  --309

<br>Получаем текущий LSN WAL и текущий LSN вставки WAL:
<br>SELECT pg_current_wal_lsn(), pg_current_wal_insert_lsn(); --1/D09B70E0 --1/D09B70E0

<br>tps = 194.502550 (without initial connection time)

<br>Вычисляем разницу между двумя LSN, чтобы понять объем изменений:
<br>SELECT '1/D09B70E0'::pg_lsn - '1/BD202710'::pg_lsn; --326846928

<br>За все контрольные точки:
<br>326846928 байт = 311,71 Мб

<br><b>Объем в среднем на одну контрольную точку:</b>
<br>311,71 / 21 = 14,84 Мб

<img width="1359" height="899" alt="3" src="https://github.com/user-attachments/assets/5940f15c-be26-4f3e-907c-b478db8e323d" />


<br><b>Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?</b>
<br>Просмотр лога:
<br>tail -n 41 postgresql-16-main.log

<br><b>Почему так произошло? - Потому что выставлен checkpoint_timeout = '30s'</b>

<img width="1890" height="871" alt="4" src="https://github.com/user-attachments/assets/8e01f004-f781-48e7-bb00-e4e4ba061307" />


<br><b>Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.</b>
<br>show synchronous_commit --on

<br>Запускаем тест на 30 секунд:
<br>pgbench -U postgres -T 30 testWal

<br>Результат:
<br>tps = 175.129292 (without initial connection time)

<br>Включаем асинхронный коммит:
<br>ALTER SYSTEM SET synchronous_commit = off;
<br>SELECT pg_reload_conf();

<br>show synchronous_commit --off

<br>Запускаем тест на 30 секунд:
<br>pgbench -U postgres -T 30 testWal

<br>Результат:
<br><b>tps = 445.443857 (without initial connection time)</b>
<br><b>Результат лучше, т.к. в режиме асинхронного подтверждения сервер сообщает об успешном завершении сразу, как только транзакция будет завершена, без записи в WAL (т.е. без сохранения на диске).</b>

<img width="1771" height="840" alt="5" src="https://github.com/user-attachments/assets/fefc3892-efa9-460d-bb14-bb71a28ef2f6" />


<br><b>Создайте новый кластер с включенной контрольной суммой страниц. Создайте таблицу. Вставьте несколько значений. Выключите кластер. Измените пару байт в таблице. Включите кластер и сделайте выборку из таблицы. Что и почему произошло? как проигнорировать ошибку и продолжить работу?</b>


<br>Останавливаем текущий кластер:
<br>sudo pg_ctlcluster 16 main stop

<br>Создаём новый кластер с включенной контрольной суммой страниц:
<br>sudo pg_createcluster 16 second -- --data-checksums

<img width="1746" height="1040" alt="6" src="https://github.com/user-attachments/assets/b4f8c9b0-8e89-4d52-af5f-27851d8df27c" />


<br>Запускаем новый кластер: 
<br>sudo pg_ctlcluster 16 second start

<br>Подключаемся к новому кластеру:
<br>sudo su postgres -c "psql --port=5433"

<br>Проверяем применение параметра data-checksums:
<br>show data_checksums;
<br>data_checksums = on

<img width="1743" height="369" alt="7" src="https://github.com/user-attachments/assets/9065d763-7e1d-448e-bdb1-0b3c4c359bbf" />


<br>Создаём базу testchs:
<br>create database testchs;

<br>Создаём в ней таблицу users:
<br>create table users (id int, name text);

<br>Заполняем таблицу users значениями:
<br>insert into users (id, name) values (1, 'Yuri'), (2, 'Vasiliy');

<br>Определяем месторасположение файла для таблицы users:
<br>select pg_relation_filepath('users');

<br>pg_relation_filepath
<br>base/16388/16395
<br>(1 row)


<br>Делаем изменения в файле таблицы (стираем из заголовка LSN последней журнальной записи):
<br>sudo dd if=/dev/zero of=/var/lib/postgresql/16/second/base/16388/16395 oflag=dsync conv=notrunc bs=1 count=8
<br>8+0 records in
<br>8+0 records out
<br>8 bytes copied, 0.0255269 s, 0.3 kB/s

<br>Запускаем кластер:
<br>sudo pg_ctlcluster 16 second start

<br>Проверяем данные в таблице users
<br>select * from users;

<br>Получаем ошибку:
<br>WARNING:  page verification failed, calculated checksum 53014 but expected 10046
<br>ERROR:  invalid page in block 0 of relation base/16388/16395

<img width="1747" height="1002" alt="8" src="https://github.com/user-attachments/assets/e0492138-3fdf-4e24-8c60-203caa25abea" />


<br><b>Что и почему произошло? Как проигнорировать ошибку и продолжить работу?</b>

<br><b>Потому что обнаружены ошибки контрольных сумм файла таблицы. Чтобы игнорировать ошибку, необходимо выставить параметр ignore_checksum_failure в значение true.</b>

<br>Проверяем значение параметра ignore_checksum_failure:
<br>show ignore_checksum_failure;
<br>ignore_checksum_failure=off

<br>Устанавливаем новое значение параметра ignore_checksum_failure: 
<br>set ignore_checksum_failure = on;

<br>Проверяем значение параметра ignore_checksum_failure:
<br>show ignore_checksum_failure;

<br>ignore_checksum_failure=on

<br>Пробуем снова прочитать данные из таблицы users:
<br>select * from users;
<br>Результат:
<br><b>Данные прочитаны, так как заголовок блока с данными уцелел</b>

<img width="1742" height="638" alt="9" src="https://github.com/user-attachments/assets/f9b779c7-0a81-4380-aa63-5d8f22558779" />

