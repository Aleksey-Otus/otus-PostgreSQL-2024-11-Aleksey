<b> Тема: Оптимизация настроек, структуры данных и запросов на PostgreSQL </b>


<br>• Подключение к виртуальной машине

<br>
<img width="3725" height="527" alt="Виртуальная машина" src="https://github.com/user-attachments/assets/422c1ad5-457c-4efa-a0aa-bd26505419ea" />

<br>• Подключение к Postgres
<br>• Загрузка БД
```
-- ресурс 
https://edu.postgrespro.ru/

-- заходим в рабочию среду postgres, вводим в терминале
sudo su - postgres

-- скачиваем демо базу данных

wget https://edu.postgrespro.ru/demo-big-20170815.zip

-- запускаем команду

zcat demo-big-20170815.zip | psql

```
<img width="1475" height="1128" alt="Загрузка БД" src="https://github.com/user-attachments/assets/5858fbd7-ab3e-4056-a557-4ea3973b6922" />
<br>
<br>
<img width="1474" height="1257" alt="Загрузка БД (2)" src="https://github.com/user-attachments/assets/592010fd-d0c8-4447-8565-91bd942ac7d5" />




<br>• Открываем DBeaver c загруженной базой

<img width="3839" height="1791" alt="БД в DBeaver" src="https://github.com/user-attachments/assets/34f9dc3b-bc04-469f-ad9e-b24d87c5161f" />
<br>
<br>
<img width="2132" height="1936" alt="БД аэропорт в DBeaver" src="https://github.com/user-attachments/assets/c639cd64-b4f0-449f-bb8a-46c1544a8421" />
<br>
<br>
<b>Настройки PostgreSQL</b>


<br>• Скрипт

```
select 
date_part('year', n.scheduled_departure) as departure,n.departure_airport,n.departure_airport_name,
n.departure_city,n.arrival_airport,n.arrival_airport_name,n.arrival_city,n.model,
sum(n.Total_Eco) as Total_Eco,
sum(n.Total_Com) as Total_Com,
sum(n.Total_Bus) as Total_Bus,
sum(n.Sum_Eco) as Sum_Eco,
sum(n.Sum_Com) as Sum_Com,
sum(n.Sum_Bus) as Sum_Bus,
count(n.flight_id) as total
--into bookings.itog_test
from(
SELECT 
f.flight_id,
    f.flight_no,
    f.departure_airport,
    dep.airport_name AS departure_airport_name,
    dep.city AS departure_city,
    f.arrival_airport,
    arr.airport_name AS arrival_airport_name,
    arr.city AS arrival_city,   
    f.aircraft_code,
    sa.model ->> lang() AS model,
    f.scheduled_departure,
    f.scheduled_arrival,
   sum(case when ff.fare_conditions = 'Economy' then 1 else 0 end) as Total_Eco,
   sum(case when ff.fare_conditions = 'Comfort' then 1 else 0 end) as Total_Com,
   sum(case when ff.fare_conditions = 'Business' then 1 else 0 end) as Total_Bus,
   sum(case when ff.fare_conditions = 'Economy' then ff.amount else 0 end) as Sum_Eco,
   sum(case when ff.fare_conditions = 'Comfort' then ff.amount else 0 end) as Sum_Com,
   sum(case when ff.fare_conditions = 'Business' then ff.amount else 0 end) as Sum_Bus
   FROM bookings.flights f
   inner join bookings.airports dep on f.departure_airport = dep.airport_code
   inner join bookings.airports arr on f.arrival_airport = arr.airport_code
   left join bookings.aircrafts_data sa on sa.aircraft_code = f.aircraft_code 
   left join bookings.ticket_flights ff on ff.flight_id  = f.flight_id 
   left join bookings.tickets t on t.ticket_no  = ff.ticket_no 
group by  
f.flight_id,f.flight_no,f.departure_airport,dep.airport_name,dep.city,f.arrival_airport,arr.airport_name,arr.city,
f.aircraft_code,sa.model ->> lang(),f.scheduled_departure,f.scheduled_arrival
)n
group by 
date_part('year', n.scheduled_departure),n.departure_airport,n.departure_airport_name,n.departure_city,
n.arrival_airport,n.arrival_airport_name,n.arrival_city,n.model
;

```

<br>• Стоимость запроса
<br> HashAggregate  (cost=27010542.96..27705577.11 rows=839128 width=376)

<img width="3260" height="2049" alt="Стоимость запроса" src="https://github.com/user-attachments/assets/596f123e-8484-48a5-8fc9-03e5a3dc0660" />

<br>• 1. shared_buffers

```
ALTER SYSTEM SET shared_buffers = '1GB';
```
<img width="1958" height="1408" alt="Настройки PostgreSQL - shared_buffers" src="https://github.com/user-attachments/assets/8b228117-d451-4e53-a93a-9f56d411deb7" />

<br> Стоимость запроса
<br> HashAggregate  (cost=27010542.96..27705577.11 rows=839128 width=376)

<img width="3121" height="1745" alt="Настройки PostgreSQL - shared_buffers (результат)" src="https://github.com/user-attachments/assets/91acc319-6c28-4273-828c-9d3e5c137ed4" />

<br>• 2. effective_cache_size

```
ALTER SYSTEM SET effective_cache_size = '2GB';
```
<img width="1978" height="1402" alt="Настройки PostgreSQL - effective_cache_size" src="https://github.com/user-attachments/assets/2a2ce4a9-238d-453e-8a68-d6f53f43cacb" />

<br> Стоимость запроса
<br> HashAggregate  (cost=27010542.96..27705577.11 rows=839128 width=376)

<img width="3074" height="1567" alt="Настройки PostgreSQL - effective_cache_size (результат)" src="https://github.com/user-attachments/assets/e82eb677-462b-4d92-b262-8fca42b83856" />

<br>• 3. work_mem

```
ALTER SYSTEM SET work_mem = '128MB';
```
<img width="2378" height="1421" alt="Настройки PostgreSQL - work_mem" src="https://github.com/user-attachments/assets/35dd7818-0e3f-46e7-8f2d-989aed0aae31" />



<br> Стоимость запроса
<br> HashAggregate  (cost=27010542.96..27705577.11 rows=839128 width=376)

<img width="3170" height="1651" alt="Настройки PostgreSQL - work_mem (результат)" src="https://github.com/user-attachments/assets/91e0d751-e74a-4c0a-a776-06626b2cf89d" />


<br> После рестарта PostgreSQL стоимость запроса уменьшилась
<br> GroupAggregate  (cost=25780387.95..26139115.25 rows=839128 width=376)

<img width="3194" height="1932" alt="Стоимость запроса после изменения настроек PostgreSQL" src="https://github.com/user-attachments/assets/545c4b29-f1a5-4394-9742-284075387657" />

<br><b> Результат Настройки PostgreSQL </b><br>
<br> До:  HashAggregate  (cost=27010542.96..27705577.11 rows=839128 width=376)
<br> После: GroupAggregate  (cost=25780387.95..26139115.25 rows=839128 width=376)

<br><b>Создал схему otus</b>

```
REATE SCHEMA otus
    AUTHORIZATION postgres;
```

<br>• Создал таблицы без индексов в схеме otus аналогичные схеме bookings только без индексов

```
--1. aircrafts_data
select *
into otus.aircrafts_data
from bookings.aircrafts_data


--2. airports_data
select *
into otus.airports_data
from bookings.airports_data

--3. boarding_passes
select *
into otus.boarding_passes
from bookings.boarding_passes

--4. bookings
select *
into otus.bookings
from bookings.bookings

--5. flights
select *
into otus.flights
from bookings.flights

--6. seats
select *
into otus.seats
from bookings.seats

--7. ticket_flights
select *
into otus.ticket_flights
from bookings.ticket_flights

--8. tickets
select *
into otus.tickets
from bookings.tickets
```

<img width="2214" height="1868" alt="Создал таблицы без индексов в схеме otus аналогичные схеме bookings только без индексов" src="https://github.com/user-attachments/assets/825da380-f0ea-4ed2-9d92-680aefb991b1" />

<br>• Проверил размер таблиц без идексов в схеме bookings и otus

```
select pg_size_pretty(pg_table_size('bookings.seats'));
select pg_size_pretty(pg_table_size('otus.seats'));
```

<img width="2289" height="1709" alt="размер таблицы без индексов" src="https://github.com/user-attachments/assets/0bc9927c-15db-4e98-925c-686c3a35f42b" />

<br>• Скрипт в схеме otus
```
select 
date_part('year', n.scheduled_departure) as departure,n.departure_airport,n.departure_airport_name,
n.departure_city,n.arrival_airport,n.arrival_airport_name,n.arrival_city,n.model,
sum(n.Total_Eco) as Total_Eco,
sum(n.Total_Com) as Total_Com,
sum(n.Total_Bus) as Total_Bus,
sum(n.Sum_Eco) as Sum_Eco,
sum(n.Sum_Com) as Sum_Com,
sum(n.Sum_Bus) as Sum_Bus,
count(n.flight_id) as total
into otus.itog_test
from(
SELECT 
f.flight_id,
    f.flight_no,
    f.departure_airport,
    dep.airport_name ->> lang() AS departure_airport_name,
    dep.city ->> lang() AS departure_city,
    f.arrival_airport,
    arr.airport_name ->> lang() AS arrival_airport_name,
    arr.city ->> lang() AS arrival_city,   
    f.aircraft_code,
    sa.model ->> lang() AS model,
    f.scheduled_departure,
    f.scheduled_arrival,
   sum(case when ff.fare_conditions = 'Economy' then 1 else 0 end) as Total_Eco,
   sum(case when ff.fare_conditions = 'Comfort' then 1 else 0 end) as Total_Com,
   sum(case when ff.fare_conditions = 'Business' then 1 else 0 end) as Total_Bus,
   sum(case when ff.fare_conditions = 'Economy' then ff.amount else 0 end) as Sum_Eco,
   sum(case when ff.fare_conditions = 'Comfort' then ff.amount else 0 end) as Sum_Com,
   sum(case when ff.fare_conditions = 'Business' then ff.amount else 0 end) as Sum_Bus
   FROM otus.flights f
   inner join otus.airports_data dep on f.departure_airport = dep.airport_code
   inner join otus.airports_data arr on f.arrival_airport = arr.airport_code
   left join otus.aircrafts_data sa on sa.aircraft_code = f.aircraft_code 
   left join otus.ticket_flights ff on ff.flight_id  = f.flight_id 
   left join otus.tickets t on t.ticket_no  = ff.ticket_no 
group by  
f.flight_id,f.flight_no,f.departure_airport,dep.airport_name ->> lang(),dep.city ->> lang(),f.arrival_airport,arr.airport_name ->> lang(),arr.city ->> lang(),
f.aircraft_code,sa.model ->> lang(),f.scheduled_departure,f.scheduled_arrival
)n
group by 
date_part('year', n.scheduled_departure),n.departure_airport,n.departure_airport_name,n.departure_city,
n.arrival_airport,n.arrival_airport_name,n.arrival_city,n.model
;
```

<br>• Стоимость запроса
<br> GroupAggregate  (cost=128042803.51..129872592.13 rows=4280207 width=376)

<img width="3759" height="2005" alt="Стоимость запроса без индексов" src="https://github.com/user-attachments/assets/8f4b1202-d78f-44e3-8c46-1e4545da175d" />

<br>
<br><b>Индексирование</b>

<br>• Индекс на таблицу otus.airports_data поле "airport_code"
```
CREATE UNIQUE INDEX airports_data_pkey ON otus.airports_data USING btree (airport_code)
```
<img width="1636" height="926" alt="Индекс на таблицу otus airports_data поле airport_code" src="https://github.com/user-attachments/assets/999bc4a5-aebf-4ab0-aa5c-2cf58bcab1c7" />

<br> Стоимость запроса
<br> GroupAggregate  (cost=128038068.69..129867857.30 rows=4280207 width=376)

<img width="1793" height="1013" alt="Индекс на таблицу otus airports_data поле airport_code (стоимость)" src="https://github.com/user-attachments/assets/b725663d-4499-436c-bdd4-8046f42bda6d" />

<br>• Индекс на таблицу otus.ticket_flights поля "ticket_no" и "flight_id"
```
CREATE UNIQUE INDEX ticket_flights_pkey ON otus.ticket_flights USING btree (ticket_no, flight_id)
```
<img width="1503" height="878" alt="Индекс на таблицу otus ticket_flights поля ticket_no и flight_id" src="https://github.com/user-attachments/assets/eb07ad9e-553d-47e2-a088-9f1b5f90fef1" />

<br> Стоимость запроса
<br> GroupAggregate  (cost=128027239.76..129856873.81 rows=4279846 width=376)

<img width="1896" height="1043" alt="Индекс на таблицу otus ticket_flights поля ticket_no и flight_id (стоимость)" src="https://github.com/user-attachments/assets/f3131670-d6bb-491e-bd51-f6e14ea774a3" />

<br>• Индекс на таблицу otus.tickets поле "ticket_no"
```
CREATE UNIQUE INDEX tickets_pkey ON otus.tickets USING btree (ticket_no)
```
<img width="1792" height="877" alt="Индекс на таблицу otus tickets поле ticket_no" src="https://github.com/user-attachments/assets/d30e80fb-d816-4a30-b723-9752b3ea3a34" />

<br> Стоимость запроса
<br> GroupAggregate  (cost=127803710.10..129633344.14 rows=4279846 width=376)

<img width="1895" height="1036" alt="Индекс на таблицу otus tickets поле ticket_no (стоимость)" src="https://github.com/user-attachments/assets/94634a7f-0db9-4b6e-9e89-94a01ee2276a" />

<br>• Индекс на таблицу otus.aircrafts_data поля "aircraft_code"
```
CREATE UNIQUE INDEX aircrafts_pkey ON otus.aircrafts_data USING btree (aircraft_code)
```
<img width="1887" height="882" alt="Индекс на таблицу otus aircrafts_data поле aircraft_code" src="https://github.com/user-attachments/assets/61f95f5f-dbdb-4307-b368-7c2b2e829b81" />

<br> Стоимость запроса
<br> GroupAggregate  (cost=1873877.42..25799276.01 rows=839185 width=376)

<img width="1905" height="1042" alt="Индекс на таблицу otus aircrafts_data поле aircraft_code (стоимость)" src="https://github.com/user-attachments/assets/e001cd17-14db-4470-9b03-aa246ae666a2" />

<br><b> Результат постройки индексов </b><br>
<br> До: GroupAggregate  (cost=128042803.51..129872592.13 rows=4280207 width=376)
<br> После: GroupAggregate  (cost=1873877.42..25799276.01 rows=839185 width=376)

<br>
<br><b> Оптимизация запросов </b><br>

<br>• Скрипт


```
SELECT
f.flight_id,
    f.flight_no,
    f.departure_airport,
    dep.airport_name ->> lang() AS departure_airport_name,
    dep.city ->> lang() AS departure_city,
    f.arrival_airport,
    arr.airport_name ->> lang() AS arrival_airport_name,
    arr.city ->> lang() AS arrival_city,   
    f.aircraft_code,
    sa.model ->> lang() AS model,
    f.scheduled_departure,
    f.scheduled_arrival
into temp tab_1
   FROM otus.flights f
   inner join otus.airports_data dep on f.departure_airport = dep.airport_code
   inner join otus.airports_data arr on f.arrival_airport = arr.airport_code
   left join otus.aircrafts_data sa on sa.aircraft_code = f.aircraft_code
;
   


   select t1.flight_id, t1.flight_no, t1.departure_airport, t1.departure_airport_name, t1.departure_city,	t1.arrival_airport,	t1.arrival_airport_name, t1.arrival_city, t1.aircraft_code, t1.model,
   t1.scheduled_departure,
   t1.scheduled_arrival,
   sum(case when ff.fare_conditions = 'Economy' then 1 else 0 end) as Total_Eco,
   sum(case when ff.fare_conditions = 'Comfort' then 1 else 0 end) as Total_Com,
   sum(case when ff.fare_conditions = 'Business' then 1 else 0 end) as Total_Bus,
   sum(case when ff.fare_conditions = 'Economy' then ff.amount else 0 end) as Sum_Eco,
   sum(case when ff.fare_conditions = 'Comfort' then ff.amount else 0 end) as Sum_Com,
   sum(case when ff.fare_conditions = 'Business' then ff.amount else 0 end) as Sum_Bus
into temp tab_2   
   from tab_1 t1
   left join otus.ticket_flights ff on ff.flight_id  = t1.flight_id 
   left join otus.tickets t on t.ticket_no  = ff.ticket_no
   group by t1.flight_id, t1.flight_no, t1.departure_airport, t1.departure_airport_name, t1.departure_city, 
   t1.arrival_airport,	t1.arrival_airport_name, t1.arrival_city, t1.aircraft_code, t1.model,
   t1.scheduled_departure, t1.scheduled_arrival   
;   
 
   
   
select 
date_part('year', n.scheduled_departure) as departure,n.departure_airport,n.departure_airport_name,
n.departure_city,n.arrival_airport,n.arrival_airport_name,n.arrival_city,n.model,
sum(n.Total_Eco) as Total_Eco,
sum(n.Total_Com) as Total_Com,
sum(n.Total_Bus) as Total_Bus,
sum(n.Sum_Eco) as Sum_Eco,
sum(n.Sum_Com) as Sum_Com,
sum(n.Sum_Bus) as Sum_Bus,
count(n.flight_id) as total
into temp tab_3
from  tab_2 n
group by 
date_part('year', n.scheduled_departure),n.departure_airport,n.departure_airport_name,n.departure_city,
n.arrival_airport,n.arrival_airport_name,n.arrival_city,n.model 
```

<br><b> Результат оптимизации запроса </b><br>
<br> Схема bookings: время выполнения 1 мин. 26 сек.
<br> Схема otus: время выполнения 56 сек.
<br> После оптимизации запроса в схеме otus: время выполнения 13 сек.

<br>• Схема bookings <br>

<img width="3836" height="2105" alt="Время выполнения в схеме bookings" src="https://github.com/user-attachments/assets/cd791c98-f08b-4b5d-a004-93a027739fcd" />

<br>• Схема otus <br>

<img width="3837" height="2094" alt="Время выполнения в схеме otus" src="https://github.com/user-attachments/assets/0834a564-fbbb-4f1b-9592-cde6866ca4d5" />

<br>• После оптимизации запроса в схеме otus <br>

<img width="3840" height="2094" alt="Время выполнения в схеме otus после оптимизации запроса" src="https://github.com/user-attachments/assets/a3a6a984-c439-49cc-80cf-c23bf23a285d" />

<br>• Количество строк в каждой выгрузке <br>

<img width="3840" height="2094" alt="Количество строк в запросах" src="https://github.com/user-attachments/assets/53c9a6f1-13b4-4a14-8de7-c57a06c9b721" />





